<!doctype html>
<html lang="uz" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diamond Rewards</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 20px rgba(139, 92, 246, 0.5); }
      50% { box-shadow: 0 0 40px rgba(139, 92, 246, 0.8); }
    }
    
    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }
    
    .float-animation {
      animation: float 3s ease-in-out infinite;
    }
    
    .glow-effect {
      animation: glow 2s ease-in-out infinite;
    }
    
    .shimmer-effect {
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      background-size: 1000px 100%;
      animation: shimmer 3s infinite;
    }
    
    .glass-card {
      background: rgba(30, 41, 59, 0.6);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(139, 92, 246, 0.2);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .neon-border {
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.5),
                  inset 0 0 20px rgba(139, 92, 246, 0.1);
    }
    
    .gradient-text {
      background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white overflow-auto">
  <div id="app" class="min-h-full w-full p-4"><!-- Loading State -->
   <div id="loading" class="flex items-center justify-center min-h-screen">
    <div class="text-center">
     <div class="w-16 h-16 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
     <p class="text-purple-300">Yuklanmoqda...</p>
    </div>
   </div><!-- Main Content -->
   <div id="content" class="hidden max-w-md mx-auto"><!-- Header -->
    <div class="glass-card rounded-3xl p-6 mb-6 neon-border">
     <div class="flex items-center space-x-4">
      <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl flex items-center justify-center float-animation text-3xl shadow-lg">
       üíé
      </div>
      <div class="flex-1">
       <h1 class="text-2xl font-bold gradient-text">Diamond Rewards</h1>
       <p class="text-purple-300 text-sm">Olmos yig'ing va mukofot oling</p>
      </div>
     </div>
    </div><!-- User Info Card -->
    <div id="user-card" class="glass-card rounded-3xl p-6 mb-6 neon-border">
     <div class="flex items-center justify-between">
      <div class="flex items-center space-x-4">
       <div id="user-avatar" class="w-14 h-14 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl flex items-center justify-center text-xl font-bold shadow-lg">
        üë§
       </div>
       <div>
        <h3 id="user-name" class="font-bold text-lg">Foydalanuvchi</h3>
        <p id="user-id" class="text-purple-300 text-sm">ID: Loading...</p>
       </div>
      </div>
      <div class="text-right">
       <div class="flex items-center space-x-2 bg-gradient-to-r from-purple-600 to-indigo-600 px-4 py-2 rounded-xl glow-effect"><span id="diamond-count" class="text-2xl font-bold">0</span> <span class="text-xl">üíé</span>
       </div>
      </div>
     </div>
    </div><!-- Ad Section -->
    <div class="glass-card rounded-3xl p-6 mb-6 neon-border">
     <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-bold">üé¨ Reklama ko'ring</h2>
      <div class="bg-purple-600 px-3 py-1 rounded-full text-sm font-bold">
       +1 üíé
      </div>
     </div>
     <p class="text-purple-300 text-sm mb-4">Har bir reklama uchun 1 olmos oling</p>
     <div id="ad-status" class="border-2 border-dashed border-purple-500 rounded-2xl p-6 mb-4 text-center">
      <p class="text-purple-300">Reklama tayyor. Tugmani bosing!</p>
     </div><button id="watch-ad-btn" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg glow-effect flex items-center justify-center space-x-2"> <span class="text-xl">‚ñ∂Ô∏è</span> <span>Reklamani boshlash</span> </button>
    </div><!-- Stats Card -->
    <div class="glass-card rounded-3xl p-6 mb-6 neon-border">
     <h3 class="text-lg font-bold mb-4 gradient-text">üìä Statistika</h3>
     <div class="grid grid-cols-2 gap-4">
      <div class="bg-gradient-to-br from-purple-600/30 to-indigo-600/30 rounded-xl p-4 text-center border border-purple-500/30">
       <p class="text-purple-300 text-sm mb-1">Ko'rilgan reklamalar</p>
       <p id="ads-watched" class="text-2xl font-bold">0</p>
      </div>
      <div class="bg-gradient-to-br from-purple-600/30 to-indigo-600/30 rounded-xl p-4 text-center border border-purple-500/30">
       <p class="text-purple-300 text-sm mb-1">Jami olmoslar</p>
       <p id="total-diamonds" class="text-2xl font-bold">0</p>
      </div>
     </div>
    </div><!-- Admin Panel -->
    <div id="admin-panel" class="hidden glass-card rounded-3xl p-6 mb-6 neon-border border-2 border-yellow-500/50">
     <h2 class="text-xl font-bold mb-4 flex items-center space-x-2"><span>üëë</span> <span class="gradient-text">Admin Panel</span></h2>
     <div class="bg-gradient-to-br from-yellow-600/20 to-orange-600/20 rounded-xl p-4 mb-4 border border-yellow-500/30">
      <h3 class="font-bold mb-2">üìà Umumiy statistika</h3>
      <div class="space-y-2 text-sm">
       <p>Jami foydalanuvchilar: <span id="admin-total-users" class="font-bold text-yellow-400">0</span></p>
       <p>Jami ko'rilgan reklamalar: <span id="admin-total-ads" class="font-bold text-yellow-400">0</span></p>
       <p>Tarqatilgan olmoslar: <span id="admin-total-diamonds" class="font-bold text-yellow-400">0</span></p>
      </div>
     </div>
     <h3 class="font-bold mb-3">üë• Foydalanuvchilar ro'yxati</h3>
     <div id="users-list" class="space-y-2 max-h-96 overflow-y-auto">
     </div>
    </div><!-- Footer -->
    <div class="text-center text-purple-400 text-sm py-4">
     <p>Telegram Mini App ‚Ä¢ Diamond Rewards System</p>
    </div>
   </div>
  </div>
  <script>
    const ADMIN_IDS = ['7500103239', '7104718080'];
    const AD_BLOCK_ID = '18961';
    const REWARD_AMOUNT = 1;
    const STORAGE_KEY = 'diamond_rewards_data';
    
    let currentUser = null;
    let allUsers = [];
    let isAdmin = false;
    let AdController = null;

    // Initialize Telegram Web App
    function initTelegram() {
      if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
        const tg = window.Telegram.WebApp;
        const user = tg.initDataUnsafe?.user;
        
        if (user) {
          currentUser = {
            user_id: user.id.toString(),
            username: user.username || 'user',
            first_name: user.first_name || 'User',
            diamonds: 0,
            ads_watched: 0,
            last_ad_time: new Date().toISOString()
          };
          isAdmin = ADMIN_IDS.includes(currentUser.user_id);
        } else {
          // Fallback for testing
          currentUser = {
            user_id: 'test_user_' + Math.floor(Math.random() * 10000),
            username: 'testuser',
            first_name: 'Test User',
            diamonds: 0,
            ads_watched: 0,
            last_ad_time: new Date().toISOString()
          };
        }
      }
    }

    // Initialize Adsgram
    function initAdsgram() {
      if (window.Adsgram) {
        AdController = window.Adsgram.init({ blockId: AD_BLOCK_ID });
        console.log('Adsgram initialized successfully');
      } else {
        console.log('Waiting for Adsgram...');
        setTimeout(initAdsgram, 500);
      }
    }

    // LocalStorage management
    function loadData() {
      try {
        const data = localStorage.getItem(STORAGE_KEY);
        if (data) {
          allUsers = JSON.parse(data);
        }
      } catch (e) {
        console.error('Error loading data:', e);
      }
    }

    function saveData() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(allUsers));
      } catch (e) {
        console.error('Error saving data:', e);
      }
    }

    function findOrCreateUser() {
      if (!currentUser) return null;
      
      let user = allUsers.find(u => u.user_id === currentUser.user_id);
      
      if (!user) {
        user = { ...currentUser };
        allUsers.push(user);
        saveData();
      }
      
      return user;
    }

    // Initialize App
    async function initializeApp() {
      initTelegram();
      loadData();
      initAdsgram();
      
      const user = findOrCreateUser();
      
      if (user) {
        updateUI();
        if (isAdmin) {
          updateAdminPanel();
        }
      }

      document.getElementById('loading').classList.add('hidden');
      document.getElementById('content').classList.remove('hidden');
    }

    function updateUI() {
      if (!currentUser) return;

      const user = allUsers.find(u => u.user_id === currentUser.user_id);
      if (!user) return;

      // Update user info
      const initials = user.first_name.charAt(0).toUpperCase();
      document.getElementById('user-avatar').textContent = initials;
      document.getElementById('user-name').textContent = user.first_name;
      document.getElementById('user-id').textContent = `ID: ${user.user_id}`;
      
      // Update diamonds
      document.getElementById('diamond-count').textContent = user.diamonds;
      document.getElementById('total-diamonds').textContent = user.diamonds;
      document.getElementById('ads-watched').textContent = user.ads_watched;

      // Show admin panel if admin
      if (isAdmin) {
        document.getElementById('admin-panel').classList.remove('hidden');
      }
    }

    function updateAdminPanel() {
      const totalUsers = allUsers.length;
      const totalAds = allUsers.reduce((sum, u) => sum + (u.ads_watched || 0), 0);
      const totalDiamonds = allUsers.reduce((sum, u) => sum + (u.diamonds || 0), 0);

      document.getElementById('admin-total-users').textContent = totalUsers;
      document.getElementById('admin-total-ads').textContent = totalAds;
      document.getElementById('admin-total-diamonds').textContent = totalDiamonds;

      // Update users list
      const usersList = document.getElementById('users-list');
      usersList.innerHTML = allUsers.map(user => `
        <div class="bg-gradient-to-br from-purple-600/20 to-indigo-600/20 rounded-xl p-3 border border-purple-500/30">
          <div class="flex items-center justify-between">
            <div>
              <p class="font-bold">${user.first_name}</p>
              <p class="text-xs text-purple-300">@${user.username} ‚Ä¢ ID: ${user.user_id}</p>
            </div>
            <div class="text-right">
              <p class="text-sm"><span class="font-bold text-yellow-400">${user.diamonds}</span> üíé</p>
              <p class="text-xs text-purple-300">${user.ads_watched} reklama</p>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Watch Ad Function
    async function watchAd() {
      const user = allUsers.find(u => u.user_id === currentUser.user_id);
      if (!user) return;

      const btn = document.getElementById('watch-ad-btn');
      const statusDiv = document.getElementById('ad-status');
      
      btn.disabled = true;
      btn.innerHTML = '<div class="w-6 h-6 border-3 border-white border-t-transparent rounded-full animate-spin mx-auto"></div>';
      statusDiv.innerHTML = '<p class="text-yellow-400 font-bold">Reklama yuklanmoqda...</p>';

      // Wait for AdController
      let attempts = 0;
      while (!AdController && attempts < 20) {
        await new Promise(resolve => setTimeout(resolve, 250));
        attempts++;
      }

      if (!AdController) {
        statusDiv.innerHTML = '<p class="text-red-400">Reklama tizimi yuklanmagan. Sahifani yangilang.</p>';
        btn.disabled = false;
        btn.innerHTML = '<span class="text-xl">‚ñ∂Ô∏è</span><span>Reklamani boshlash</span>';
        return;
      }

      try {
        statusDiv.innerHTML = '<p class="text-green-400 font-bold">üé¨ Reklama ko\'rsatilmoqda...</p>';
        
        // Show Ad - Rewarded format
        await AdController.show();
        
        // User watched ad till the end - Give reward
        user.diamonds += REWARD_AMOUNT;
        user.ads_watched += 1;
        user.last_ad_time = new Date().toISOString();
        
        saveData();
        updateUI();
        if (isAdmin) {
          updateAdminPanel();
        }

        statusDiv.innerHTML = `
          <div class="text-center">
            <div class="text-4xl mb-2 animate-bounce">üéâ</div>
            <p class="text-green-400 font-bold">Tabriklaymiz! +${REWARD_AMOUNT} üíé</p>
            <p class="text-sm text-purple-300 mt-1">Reklama to'liq ko'rildi</p>
          </div>
        `;
      } catch (error) {
        console.error('Ad error:', error);
        
        if (error && error.error) {
          statusDiv.innerHTML = `<p class="text-red-400">Xatolik: ${error.description || 'Reklama yuklanmadi'}</p>`;
        } else if (error && error.done === false) {
          statusDiv.innerHTML = '<p class="text-orange-400">Reklama to\'liq ko\'rilmadi. Mukofot berilmadi.</p>';
        } else {
          statusDiv.innerHTML = '<p class="text-orange-400">Reklama yopildi yoki xatolik yuz berdi.</p>';
        }
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<span class="text-xl">‚ñ∂Ô∏è</span><span>Reklamani boshlash</span>';
        
        setTimeout(() => {
          statusDiv.innerHTML = '<p class="text-purple-300">Reklama tayyor. Tugmani bosing!</p>';
        }, 3000);
      }
    }

    // Event Listeners
    document.getElementById('watch-ad-btn')?.addEventListener('click', watchAd);

    // Initialize on load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9acccae2f0483d14',t:'MTc2NTUzODAwNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
