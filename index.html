<!doctype html>
<html lang="uz" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diamond Rewards</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 20px rgba(139, 92, 246, 0.5); }
      50% { box-shadow: 0 0 40px rgba(139, 92, 246, 0.8); }
    }
    
    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }
    
    .float-animation {
      animation: float 3s ease-in-out infinite;
    }
    
    .glow-effect {
      animation: glow 2s ease-in-out infinite;
    }
    
    .shimmer-effect {
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      background-size: 1000px 100%;
      animation: shimmer 3s infinite;
    }
    
    .glass-card {
      background: rgba(30, 41, 59, 0.6);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(139, 92, 246, 0.2);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .neon-border {
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.5),
                  inset 0 0 20px rgba(139, 92, 246, 0.1);
    }
    
    .gradient-text {
      background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white overflow-auto">
  <div id="app" class="min-h-full w-full p-4"><!-- Loading State -->
   <div id="loading" class="flex items-center justify-center min-h-screen">
    <div class="text-center">
     <div class="w-16 h-16 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
     <p class="text-purple-300">Yuklanmoqda...</p>
    </div>
   </div><!-- Main Content -->
   <div id="content" class="hidden max-w-md mx-auto"><!-- Header -->
    <div class="glass-card rounded-3xl p-6 mb-6 neon-border">
     <div class="flex items-center space-x-4">
      <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl flex items-center justify-center float-animation text-3xl shadow-lg">
       üíé
      </div>
      <div class="flex-1">
       <h1 class="text-2xl font-bold gradient-text">Diamond Rewards</h1>
       <p class="text-purple-300 text-sm">Olmos yig'ing va mukofot oling</p>
      </div>
     </div>
    </div><!-- User Info Card -->
    <div id="user-card" class="glass-card rounded-3xl p-6 mb-6 neon-border">
     <div class="flex items-center justify-between">
      <div class="flex items-center space-x-4">
       <div id="user-avatar" class="w-14 h-14 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl flex items-center justify-center text-xl font-bold shadow-lg">
       </div>
       <div>
        <h3 id="user-name" class="font-bold text-lg"></h3>
        <p id="user-id" class="text-purple-300 text-sm"></p>
       </div>
      </div>
      <div class="text-right">
       <div class="flex items-center space-x-2 bg-gradient-to-r from-purple-600 to-indigo-600 px-4 py-2 rounded-xl glow-effect"><span id="diamond-count" class="text-2xl font-bold">0</span> <span class="text-xl">üíé</span>
       </div>
      </div>
     </div>
    </div><!-- Ad Section -->
    <div class="glass-card rounded-3xl p-6 mb-6 neon-border">
     <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-bold">üé¨ Reklama ko'ring</h2>
      <div class="bg-purple-600 px-3 py-1 rounded-full text-sm font-bold">
       +1 üíé
      </div>
     </div>
     <p class="text-purple-300 text-sm mb-4">Har bir reklama uchun 1 olmos oling</p>
     <div id="ad-status" class="border-2 border-dashed border-purple-500 rounded-2xl p-6 mb-4 text-center">
      <p class="text-purple-300">Reklama tayyor. Tugmani bosing!</p>
     </div><button id="watch-ad-btn" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg glow-effect flex items-center justify-center space-x-2"> <span class="text-xl">‚ñ∂Ô∏è</span> <span>Reklamani boshlash</span> </button>
    </div><!-- Stats Card -->
    <div class="glass-card rounded-3xl p-6 mb-6 neon-border">
     <h3 class="text-lg font-bold mb-4 gradient-text">ÔøΩÔøΩÔøΩÔøΩ Statistika</h3>
     <div class="grid grid-cols-2 gap-4">
      <div class="bg-gradient-to-br from-purple-600/30 to-indigo-600/30 rounded-xl p-4 text-center border border-purple-500/30">
       <p class="text-purple-300 text-sm mb-1">Ko'rilgan reklamalar</p>
       <p id="ads-watched" class="text-2xl font-bold">0</p>
      </div>
      <div class="bg-gradient-to-br from-purple-600/30 to-indigo-600/30 rounded-xl p-4 text-center border border-purple-500/30">
       <p class="text-purple-300 text-sm mb-1">Jami olmoslar</p>
       <p id="total-diamonds" class="text-2xl font-bold">0</p>
      </div>
     </div>
    </div><!-- Admin Panel -->
    <div id="admin-panel" class="hidden glass-card rounded-3xl p-6 mb-6 neon-border border-2 border-yellow-500/50">
     <h2 class="text-xl font-bold mb-4 flex items-center space-x-2"><span>üëë</span> <span class="gradient-text">Admin Panel</span></h2>
     <div class="bg-gradient-to-br from-yellow-600/20 to-orange-600/20 rounded-xl p-4 mb-4 border border-yellow-500/30">
      <h3 class="font-bold mb-2">üìà Umumiy statistika</h3>
      <div class="space-y-2 text-sm">
       <p>Jami foydalanuvchilar: <span id="admin-total-users" class="font-bold text-yellow-400">0</span></p>
       <p>Jami ko'rilgan reklamalar: <span id="admin-total-ads" class="font-bold text-yellow-400">0</span></p>
       <p>Tarqatilgan olmoslar: <span id="admin-total-diamonds" class="font-bold text-yellow-400">0</span></p>
      </div>
     </div>
     <h3 class="font-bold mb-3">üë• Foydalanuvchilar ro'yxati</h3>
     <div id="users-list" class="space-y-2 max-h-96 overflow-y-auto">
     </div>
    </div><!-- Footer -->
    <div class="text-center text-purple-400 text-sm py-4">
     <p>Telegram Mini App ‚Ä¢ Server sinxronizatsiyasi</p>
    </div>
   </div>
  </div>
  <script>
    const ADMIN_IDS = ['7500103239', '7104718080'];
    const AD_BLOCK_ID = '18961';
    const REWARD_AMOUNT = 1; // 1 olmos har bir reklama uchun
    
    let currentUser = null;
    let allUsers = [];
    let isAdmin = false;
    let AdController = null;

    const defaultConfig = {
      app_title: "Diamond Rewards",
      primary_color: "#8b5cf6",
      secondary_color: "#6366f1",
      background_color: "#0f172a"
    };

    // Initialize Telegram Web App
    if (window.Telegram?.WebApp) {
      window.Telegram.WebApp.ready();
      window.Telegram.WebApp.expand();
      const tg = window.Telegram.WebApp;
      const user = tg.initDataUnsafe?.user;
      
      if (user) {
        currentUser = {
          user_id: user.id.toString(),
          username: user.username || 'user',
          first_name: user.first_name || 'User'
        };
        isAdmin = ADMIN_IDS.includes(currentUser.user_id);
      }
    }

    // Initialize Adsgram after page load
    function initAdsgram() {
      if (window.Adsgram) {
        AdController = window.Adsgram.init({ blockId: AD_BLOCK_ID });
        console.log('Adsgram initialized');
      } else {
        console.log('Adsgram not loaded yet');
        setTimeout(initAdsgram, 500);
      }
    }
    
    // Wait for Adsgram to load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initAdsgram);
    } else {
      initAdsgram();
    }

    // Data SDK Handler
    const dataHandler = {
      onDataChanged(data) {
        allUsers = data;
        updateUI();
        if (isAdmin) {
          updateAdminPanel();
        }
      }
    };

    // Initialize Data SDK
    async function initializeApp() {
      const initResult = await window.dataSdk.init(dataHandler);
      if (!initResult.isOk) {
        console.error('Failed to initialize Data SDK');
        showError('Xatolik yuz berdi. Iltimos qaytadan urinib ko\'ring.');
        return;
      }

      // Find or create current user
      if (currentUser) {
        const existingUser = allUsers.find(u => u.user_id === currentUser.user_id);
        if (!existingUser) {
          const createResult = await window.dataSdk.create({
            user_id: currentUser.user_id,
            username: currentUser.username,
            first_name: currentUser.first_name,
            diamonds: 0,
            ads_watched: 0,
            last_ad_time: new Date().toISOString()
          });
          
          if (!createResult.isOk) {
            showError('Foydalanuvchi yaratishda xatolik.');
          }
        }
      }

      document.getElementById('loading').classList.add('hidden');
      document.getElementById('content').classList.remove('hidden');
    }

    function updateUI() {
      if (!currentUser) return;

      const user = allUsers.find(u => u.user_id === currentUser.user_id);
      if (!user) return;

      // Update user info
      const initials = user.first_name.charAt(0).toUpperCase();
      document.getElementById('user-avatar').textContent = initials;
      document.getElementById('user-name').textContent = user.first_name;
      document.getElementById('user-id').textContent = `ID: ${user.user_id}`;
      
      // Update diamonds
      document.getElementById('diamond-count').textContent = user.diamonds;
      document.getElementById('total-diamonds').textContent = user.diamonds;
      document.getElementById('ads-watched').textContent = user.ads_watched;

      // Show admin panel if admin
      if (isAdmin) {
        document.getElementById('admin-panel').classList.remove('hidden');
      }
    }

    function updateAdminPanel() {
      const totalUsers = allUsers.length;
      const totalAds = allUsers.reduce((sum, u) => sum + (u.ads_watched || 0), 0);
      const totalDiamonds = allUsers.reduce((sum, u) => sum + (u.diamonds || 0), 0);

      document.getElementById('admin-total-users').textContent = totalUsers;
      document.getElementById('admin-total-ads').textContent = totalAds;
      document.getElementById('admin-total-diamonds').textContent = totalDiamonds;

      // Update users list
      const usersList = document.getElementById('users-list');
      usersList.innerHTML = allUsers.map(user => `
        <div class="bg-gradient-to-br from-purple-600/20 to-indigo-600/20 rounded-xl p-3 border border-purple-500/30">
          <div class="flex items-center justify-between">
            <div>
              <p class="font-bold">${user.first_name}</p>
              <p class="text-xs text-purple-300">@${user.username} ‚Ä¢ ID: ${user.user_id}</p>
            </div>
            <div class="text-right">
              <p class="text-sm"><span class="font-bold text-yellow-400">${user.diamonds}</span> üíé</p>
              <p class="text-xs text-purple-300">${user.ads_watched} reklama</p>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Watch Ad Function with Adsgram
    async function watchAd() {
      if (allUsers.length >= 999) {
        showError('Maksimal foydalanuvchilar limitiga yetildi (999). Iltimos adminlarga murojaat qiling.');
        return;
      }

      const user = allUsers.find(u => u.user_id === currentUser.user_id);
      if (!user) {
        showError('Foydalanuvchi topilmadi');
        return;
      }

      const btn = document.getElementById('watch-ad-btn');
      const statusDiv = document.getElementById('ad-status');
      
      btn.disabled = true;
      btn.innerHTML = '<div class="w-6 h-6 border-3 border-white border-t-transparent rounded-full animate-spin mx-auto"></div>';
      statusDiv.innerHTML = '<p class="text-yellow-400 font-bold">Reklama yuklanmoqda...</p>';

      // Wait for AdController to be ready
      let attempts = 0;
      while (!AdController && attempts < 10) {
        await new Promise(resolve => setTimeout(resolve, 500));
        attempts++;
      }

      if (!AdController) {
        statusDiv.innerHTML = '<p class="text-red-400">Reklama tizimi yuklanmagan. Sahifani yangilang.</p>';
        btn.disabled = false;
        btn.innerHTML = '<span class="text-xl">‚ñ∂Ô∏è</span><span>Reklamani boshlash</span>';
        return;
      }

      try {
        statusDiv.innerHTML = '<p class="text-green-400 font-bold">Reklama boshlanmoqda...</p>';
        
        // Show Ad using Adsgram - Rewarded format
        const result = await AdController.show();
        
        console.log('Ad result:', result);
        
        // User watched ad till the end - Give reward
        const updatedUser = {
          ...user,
          diamonds: user.diamonds + REWARD_AMOUNT,
          ads_watched: user.ads_watched + 1,
          last_ad_time: new Date().toISOString()
        };

        const updateResult = await window.dataSdk.update(updatedUser);
        
        if (updateResult.isOk) {
          statusDiv.innerHTML = `
            <div class="text-center">
              <div class="text-4xl mb-2 animate-bounce">üéâ</div>
              <p class="text-green-400 font-bold">Tabriklaymiz! +${REWARD_AMOUNT} üíé</p>
              <p class="text-sm text-purple-300 mt-1">Reklama to'liq ko'rildi</p>
            </div>
          `;
        } else {
          throw new Error('Mukofot berishda xatolik');
        }
      } catch (error) {
        console.error('Ad error:', error);
        // User closed ad early or error occurred
        if (error && error.error) {
          statusDiv.innerHTML = `<p class="text-red-400">Xatolik: ${error.description || 'Noma\'lum xatolik'}</p>`;
        } else if (error && error.done === false) {
          statusDiv.innerHTML = '<p class="text-orange-400">Reklama to\'liq ko\'rilmadi. Mukofot berilmadi.</p>';
        } else {
          statusDiv.innerHTML = '<p class="text-orange-400">Reklama yuklanmadi. Qaytadan urinib ko\'ring.</p>';
        }
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<span class="text-xl">‚ñ∂Ô∏è</span><span>Reklamani boshlash</span>';
        
        setTimeout(() => {
          statusDiv.innerHTML = '<p class="text-purple-300">Reklama tayyor. Tugmani bosing!</p>';
        }, 3000);
      }
    }

    function showError(message) {
      const statusDiv = document.getElementById('ad-status');
      statusDiv.innerHTML = `<p class="text-red-400">${message}</p>`;
    }

    // Event Listeners
    document.getElementById('watch-ad-btn')?.addEventListener('click', watchAd);

    // Element SDK Implementation
    async function onConfigChange(config) {
      const title = config.app_title || defaultConfig.app_title;
      document.title = title;
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ["app_title", config.app_title || defaultConfig.app_title]
        ])
      });
    }

    // Initialize on load
    initializeApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9accc5fb31f43d14',t:'MTc2NTUzNzgwNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
