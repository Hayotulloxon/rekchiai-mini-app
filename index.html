<!doctype html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diamond Rewards</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #f1f5f9;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .app-container {
            width: 100%;
            max-width: 400px;
            background: #1e293b;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            border: 1px solid #334155;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .logo {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .title {
            font-size: 24px;
            font-weight: bold;
            color: #f8fafc;
            margin-bottom: 5px;
        }

        .subtitle {
            font-size: 14px;
            color: #94a3b8;
        }

        .user-card {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            color: white;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: bold;
            font-size: 16px;
            color: white;
        }

        .user-id {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 2px;
        }

        .balance-card {
            background: #2d3748;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            border: 1px solid #4a5568;
        }

        .balance-label {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .balance-value {
            font-size: 32px;
            font-weight: bold;
            color: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .balance-sync {
            font-size: 12px;
            color: #64748b;
            margin-top: 8px;
        }

        .ad-section {
            background: #2d3748;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #4a5568;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #f8fafc;
            margin-bottom: 8px;
        }

        .section-subtitle {
            font-size: 13px;
            color: #94a3b8;
            margin-bottom: 16px;
        }

        .ad-button {
            width: 100%;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.2s;
        }

        .ad-button:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .ad-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .ad-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            font-size: 12px;
            color: #94a3b8;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 500;
            z-index: 1000;
            display: none;
            max-width: 90%;
        }

        .toast.error {
            background: #ef4444;
        }

        .admin-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 10px;
            padding: 8px 12px;
            font-size: 12px;
            cursor: pointer;
            display: none;
        }

        .admin-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            padding: 20px;
        }

        .admin-content {
            background: #1e293b;
            border-radius: 20px;
            padding: 24px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid #4a5568;
        }

        .admin-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #f8fafc;
            text-align: center;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .admin-stat {
            background: #2d3748;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .admin-stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #f8fafc;
        }

        .admin-stat-label {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }

        .admin-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <button class="admin-button" id="adminButton">Admin</button>
    
    <div class="app-container">
        <div class="header">
            <div class="logo">üíé</div>
            <div class="title">Diamond Rewards</div>
            <div class="subtitle">Olmos yig'ing va mukofot oling</div>
        </div>

        <div class="user-card">
            <div class="avatar" id="avatar">TG</div>
            <div class="user-info">
                <div class="user-name" id="userName">Foydalanuvchi</div>
                <div class="user-id" id="userId">ID: -</div>
            </div>
        </div>

        <div class="balance-card">
            <div class="balance-label">Joriy balans</div>
            <div class="balance-value">
                <span>üíé</span>
                <span id="balanceValue">0</span>
            </div>
            <div class="balance-sync" id="balanceSync">Yuklanmoqda...</div>
        </div>

        <div class="ad-section">
            <div class="section-title">üé¨ Reklama ko'ring</div>
            <div class="section-subtitle">Har bir reklama uchun 1 olmos oling</div>
            <button class="ad-button" id="showAdButton">
                <span>‚ñ∂Ô∏è</span>
                <span>Reklamani boshlash</span>
            </button>
            <div class="ad-stats">
                <span>Bugun: <span id="adTodayCount">0</span> ta</span>
                <span>+1 üíé har bir reklama</span>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">Xabar</div>

    <div class="admin-panel" id="adminPanel">
        <button class="admin-close" id="adminClose">√ó</button>
        <div class="admin-content">
            <div class="admin-title">üìä Admin Panel</div>
            <div class="admin-stats">
                <div class="admin-stat">
                    <div class="admin-stat-value" id="statUsers">0</div>
                    <div class="admin-stat-label">Foydalanuvchilar</div>
                </div>
                <div class="admin-stat">
                    <div class="admin-stat-value" id="statAds">0</div>
                    <div class="admin-stat-label">Jami reklamalar</div>
                </div>
            </div>
            <div id="userStats"></div>
        </div>
    </div>

    <script>
        // Konfiguratsiya
        const ADSGRAM_BLOCK_ID = "18961";
        const API_URL = "api.php";
        const ADMIN_IDS = ["7500103239", "7104718080"];
        const TOKEN = "4564564asf78954e65g4a7g98a4ga6s5g48as7g98as8g456";

        // O'zgaruvchilar
        let currentUser = null;
        let balance = 0;
        let adTodayCount = 0;
        let adController = null;

        // DOM elementlari
        const avatarEl = document.getElementById('avatar');
        const userNameEl = document.getElementById('userName');
        const userIdEl = document.getElementById('userId');
        const balanceValueEl = document.getElementById('balanceValue');
        const balanceSyncEl = document.getElementById('balanceSync');
        const showAdButton = document.getElementById('showAdButton');
        const adTodayCountEl = document.getElementById('adTodayCount');
        const toastEl = document.getElementById('toast');
        const adminButton = document.getElementById('adminButton');
        const adminPanel = document.getElementById('adminPanel');
        const adminClose = document.getElementById('adminClose');

        // Toast xabarlari
        function showToast(message, isError = false) {
            toastEl.textContent = message;
            toastEl.className = 'toast' + (isError ? ' error' : '');
            toastEl.style.display = 'block';
            
            setTimeout(() => {
                toastEl.style.display = 'none';
            }, 3000);
        }

        // Telegram muhitini tekshirish
        function isTelegramEnv() {
            return window.Telegram?.WebApp?.initDataUnsafe?.user;
        }

        // Balansni yangilash
        async function updateBalance() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'get_balance',
                        user_id: currentUser.id,
                        token: TOKEN
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    balance = data.balance;
                    balanceValueEl.textContent = balance;
                    balanceSyncEl.textContent = '‚úì Onlayn';
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                balanceSyncEl.textContent = '‚ö†Ô∏è Offline';
            }
        }

        // Olmos qo'shish
        async function addDiamond() {
            if (!currentUser) return;
            
            showAdButton.disabled = true;
            showAdButton.innerHTML = '<span>‚è≥</span><span>Kutilmoqda...</span>';
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'add_diamond',
                        user_id: currentUser.id,
                        token: TOKEN
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    balance = data.balance;
                    balanceValueEl.textContent = balance;
                    adTodayCount++;
                    adTodayCountEl.textContent = adTodayCount;
                    showToast('üéâ +1 olmos qo\'shildi!');
                } else {
                    showToast(data.error, true);
                }
            } catch (error) {
                showToast('Server xatosi', true);
            }
            
            showAdButton.disabled = false;
            showAdButton.innerHTML = '<span>‚ñ∂Ô∏è</span><span>Reklamani boshlash</span>';
        }

        // Adsgram SDK
        function initAdsgram() {
            if (typeof Adsgram === 'undefined') {
                showToast('Reklama SDK yuklanmadi', true);
                return false;
            }
            
            try {
                adController = Adsgram.init({ blockId: ADSGRAM_BLOCK_ID });
                
                adController.addEventListener('onReward', () => {
                    addDiamond();
                });
                
                adController.addEventListener('onError', () => {
                    showToast('Reklama xatosi', true);
                });
                
                adController.addEventListener('onSkip', () => {
                    showToast('Reklama to\'xtatildi', true);
                });
                
                return true;
            } catch (e) {
                showToast('SDK ishga tushmadi', true);
                return false;
            }
        }

        // Admin panel
        async function loadAdminStats() {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'get_stats',
                        token: TOKEN
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('statUsers').textContent = data.total_users;
                    document.getElementById('statAds').textContent = data.total_ads;
                    
                    const userStatsEl = document.getElementById('userStats');
                    userStatsEl.innerHTML = '';
                    
                    if (data.users.length === 0) {
                        userStatsEl.innerHTML = '<div style="text-align:center;color:#94a3b8;padding:20px;">Foydalanuvchilar yo\'q</div>';
                        return;
                    }
                    
                    data.users.forEach((user, index) => {
                        const div = document.createElement('div');
                        div.style.cssText = `
                            background: #2d3748;
                            border-radius: 10px;
                            padding: 12px;
                            margin-bottom: 8px;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        `;
                        
                        div.innerHTML = `
                            <div>
                                <div style="font-weight:bold;color:#f8fafc">${user.username}</div>
                                <div style="font-size:12px;color:#94a3b8">ID: ${user.id}</div>
                            </div>
                            <div style="text-align:right">
                                <div style="font-weight:bold;color:#f8fafc">${user.balance} üíé</div>
                                <div style="font-size:12px;color:#94a3b8">${user.ads_count} ta reklama</div>
                            </div>
                        `;
                        
                        userStatsEl.appendChild(div);
                    });
                }
            } catch (error) {
                console.error('Admin stats error:', error);
            }
        }

        // Asosiy ilk yuklash
        function initApp() {
            if (!isTelegramEnv()) {
                showToast('Faqat Telegram ichida ishlaydi', true);
                showAdButton.disabled = true;
                return;
            }
            
            const tg = window.Telegram.WebApp;
            tg.ready();
            
            const user = tg.initDataUnsafe.user;
            if (!user) {
                showToast('Foydalanuvchi topilmadi', true);
                return;
            }
            
            currentUser = {
                id: String(user.id),
                first_name: user.first_name || '',
                last_name: user.last_name || '',
                username: user.username || ''
            };
            
            // Foydalanuvchi ma'lumotlarini ko'rsatish
            const fullName = (currentUser.first_name + ' ' + (currentUser.last_name || '')).trim();
            userNameEl.textContent = fullName || 'Foydalanuvchi';
            userIdEl.textContent = `ID: ${currentUser.id}`;
            
            // Avatar bosh harflari
            let initials = '';
            if (currentUser.first_name) initials += currentUser.first_name[0];
            if (currentUser.last_name) initials += currentUser.last_name[0];
            if (!initials && currentUser.username) initials = currentUser.username[0];
            if (!initials) initials = 'TG';
            avatarEl.textContent = initials.toUpperCase();
            
            // Admin panelni ko'rsatish
            if (ADMIN_IDS.includes(currentUser.id)) {
                adminButton.style.display = 'block';
            }
            
            // Balansni yuklash
            updateBalance();
            
            // Adsgram ni ishga tushirish
            initAdsgram();
            
            // Telegram UI
            try {
                tg.setHeaderColor('#8b5cf6');
                tg.setBackgroundColor('#1e293b');
            } catch (e) {}
        }

        // Event listenerlar
        showAdButton.addEventListener('click', () => {
            if (!adController) {
                showToast('Reklama tayyor emas', true);
                return;
            }
            
            adController.show().catch(() => {
                showToast('Reklama ochilmadi', true);
            });
        });
        
        adminButton.addEventListener('click', () => {
            loadAdminStats();
            adminPanel.style.display = 'flex';
        });
        
        adminClose.addEventListener('click', () => {
            adminPanel.style.display = 'none';
        });
        
        adminPanel.addEventListener('click', (e) => {
            if (e.target === adminPanel) {
                adminPanel.style.display = 'none';
            }
        });

        // Ilk yuklash
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
